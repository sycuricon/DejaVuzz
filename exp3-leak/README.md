# Experiment E3

Experiment E3 is used to compare the fuzzing coverage between DejaVuzz and SpecDoctor for spreading secret within compoments of processor.

## Setup

1. set up the experiment environment following the README in root directory

2. export `DEJAVUZZ` shell variant to directory of toolchian

```sh
    export DEJAVUZZ=/path/to/toolchain
```

You can construct your toolchain by the steps in root directory's README.

3. download dataset to exp3-leak/leak_dataset path.

```
TODO:
```

4. compile the DejaVuzz framework in folder `specdoctor` before executing.

```
make -C specdoctor vcs
```

## Directory Hierarchy of Dataset

The final directory hierarchy of the `leak_dataset` is as follows:

```
.
├── dejavuzz
└── specdoctor
    ├── spec_0
    ├── spec_1
    ├── spec_2
    ├── spec_3
    └── spec_4
```

* `dejavuzz`: it is a empty folder
* `specdoctor/*`: it is the dataset of testcases generated by SpecDoctor's fuzzing. 5 groups of testcases are generated under 5 kinds of SpecDoctor fuzzing configurations. Each group has more than 20000 testcases. Only the RTL design in `exp3-leak/specdoctor` can execute the testcase in `leak_dataset/specdoctor`.

## Execute experiment

1. execute `python leak_replace_execute.py` to change the `FILE_PATH` in leak_dataset's `swap_mem.cfg`.

2. execute `python specdoctor_leak_execute.py` to execute the testcases in `leak_dataset/specdoctor`. It is equivalent to reply the SpecDoctor fuzzing procedure to get the coverage curve in the standard of DejaVuzz. The data of coverage curves is recored in `specdoctor_result_xx-xx-xx-xx-xx-xx` folder, the `xx-xx-xx-xx-xx-xx` is the start execution time of `python specdoctor_leak_execute.py`.

For example, if I execute `specdoctor_leak_execute.py` in `20:50:56, 2024.12.27`. The result is in `specdoctor_result_2024-12-27-20-50-56`. Each file in this folder is corresponding to a coverage curve in different SpecDoctor fuzzing configuration.

```
.
├── spec_0
├── spec_1
├── spec_2
├── spec_3
└── spec_4
```

3. set up the stimulus template generator `razzle`. Razzle is used to generate simulation stimulus for RTL and to provide the fuzzing framework.

```bash
git clone https://github.com/sycuricon/InstGenerator.git
cd InstGenerator
pip3 install -r requirements.txt
```

4. execute `python dejavuzz_leak_execute.py` to use `razzle` do fuzzing on BOOM(SpecDoctor only support fuzzing on BOOM). This fuzzing will execute 20000 different testcases for DejaVuzz and DejaVuzz-(DejaVuzz without coverage guidence), and store the coverage in `dejavuzz_result_xx-xx-xx-xx-xx-xx`, the `xx-xx-xx-xx-xx-xx` is the start execution time of `python dejavuzz_leak_execute.py`.

5. execute following command to draw the figure of DejaVuzz's and SpecDoctor's coverage curve. 

```sh
python coverage_analysis.py --specdoctor_path /path/to/specdoctor_result --dejavuzz_path /path/to/dejavuzz_result
```

* `/path/to/specdoctor` is the target result folder generated by `python specdoctor_leak_execute.py`.
* `/path/to/dejavuzz` is the target result folder generated by `python dejavuzz_leak_execute.py`.

The figure is stored as `Exp3_Coverage_xx-xx-xx-xx-xx-xx`, the `xx-xx-xx-xx-xx-xx` is the start execution time of `python coverage_analysis.py`.

## Execute fuzzing

If you want to execute transient execution vulnerabilities fuzzing, back to the repository root directory and execute command `make do-fuzz`. It will begin to fuzz and store the fuzzing result in `build` directory.
- Overwrite the `TARGET_CORE` to customize the target core
    - `TARGET_CORE=BOOM`: fuzzing for BOOM processor in `starship-parafuzz`
    - `TARGET_CORE=XiangShan`: fuzzing for XiangShan processor in `xiangshan-dejavuzz`
    - The default value of `TARGET_CORE` is `BOOM`
- Overwrite the `PREFIX` to customize the prefix of the generated filename during fuzzing
    - If two fuzzing process use the same `PREFIX`, their producing files will overwrite each other. So different fuzzing process should be given different prefix.
    - The default value of `PREFIX` is the vaule of the `TARGET_CORE`
- Overwrite the `THREAD_NUM` to customize the maximum thread number to execute the simulation of RTL
    - Because the number of VCS license is only 32 in our servers, so the `THREAD_NUM` cannot be larger than 32
    - The default value of `THREAD_NUM` is 16

For example we execute:
```sh
make do-fuzz PREFIX=group_0x6c28e89 TARGET_CORE=BOOM THREAD_NUM=8
```
Then the DejaVuzz will execute fuzzing test for BOOM processor by 8 threads. The fuzzing result is stored in the `build/BOOM_group_0x6c28e89`, the path consists of the `TARGET_CORE` and the `PREFIX`. The fuzzing will not stop until you kill the process handly(the `dejavuzz_leak_execute` can stop the execution of fuzzing automatically). The final directory hierarchy of it is as follows:

```
.
├── analysis_result         # the analysis result of the fuzzing
├── fuzz_code               # the simulation stimulus during fuzzing
├── script_workspace        # the temporary script during fuzzing
└── template_repo           # the information of fuzz code and the poc found during fuzzing
```

then execute
```sh
make analysis PREFIX=group_0x6c28e89 TARGET_CORE=BOOM
```
It will analysis the fuzzing product in the `build/BOOM_group_0x6c28e89` and store the analysis result in `analysis_result` directory.


