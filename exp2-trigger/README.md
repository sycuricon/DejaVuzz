# Experiment E2

Experiment E2 is used to compute the trainning overhead of DejaVuzz and SpecDoctor for triggering transient execution window.

## Setup

1. set up the experiment environment following the README in root directory

2. export `DEJAVUZZ` shell variant to directory of toolchian

```sh
    export DEJAVUZZ=/path/to/toolchain
```

You can construct your toolchain by the steps in root directory's README.

3. download dataset to exp2-trigger/trigger_dataset path.

```
TODO:
```

4. create soft link to `exp1-case/BOOM`

```
ln -s ../exp1-case/BOOM
```

5. set up the stimulus template generator `razzle`. Razzle is used to generate simulation stimulus for RTL and to provide the fuzzing framework.

```bash
git clone https://github.com/sycuricon/InstGenerator.git
cd InstGenerator
pip3 install -r requirements.txt
```

## Directory Hierarchy of Dataset

`trigger_dataset` is the dataset of testcase generated by 5 group experiments listed in Table3. The final directory hierarchy of the `trigger_dataset` is as follows:

```
.
└── specdoctor
    ├── S2M_ATTACKER
    ├── S2M_VICTIM
    ├── S2M_VICTIM_2
    ├── U2M_ATTACKER
    ├── U2S_ATTACKER
    ├── U2S_VICTIM
    └── U2S_VICTIM_2
```

* `specdoctor/*` are the trigger testcase set of `BOOM SpecDoctor`

## Execute experiment

1. run `python dejavuzz_trigger_execute.py` to run four trigger configuration, `BOOM DejaVuzz`, `BOOM DejaVuzz*`, `XiangShan DejaVuzz`, `XiangShan DejaVuzz*`. The fuzz result is in `exp2-trigger/build`. The execute `python dejavuzz_trigger_statistic_runtime.py` to statstic the trainning overhead of four configurations.

```
$ python dejavuzz_trigger_statistic.py 
BOOM_trigger_test:
load/store access fault:        ave_line_num:0.0        ave_valid_num:0.0
load/store page fault:  ave_line_num:0.0        ave_valid_num:0.0
load/store misalign:    ave_line_num:0.0        ave_valid_num:0.0
illegal instruction:    ave_line_num:*  ave_valid_num:*
memory  disambiguation: ave_line_num:0.0        ave_valid_num:0.0
branch mispredict:      ave_line_num:86.4       ave_valid_num:3.8
indirect jump mispredict:       ave_line_num:85.7       ave_valid_num:2.8
return address mispredict:      ave_line_num:85.6       ave_valid_num:2.7
straight line speculation:      ave_line_num:0.0        ave_valid_num:0.0

BOOM_random_trigger_test:
...

XiangShan_trigger_test:
...

XiangShan_random_trigger_test:
...

```

`BOOM DejaVuzz`, `BOOM DejaVuzz*`, `XiangShan DejaVuzz`, `XiangShan DejaVuzz*` are corresponding to `BOOM_trigger_test`, `BOOM_random_trigger_test`, `XiangShan_trigger_test` and `XiangShan_trigger_test` in output of script. `ave_line_num` and `ave_valid_num` are corresponding to the TO and ETO in Table 3.

2. run `python specdoctor_trigger_statistic_dataset.py` to statstic the trainning overhead of SpecDoctor.

```
$ python specdoctor_trigger_statstic.py 
page-fault: 17833, 2243508, 125.80653843997084
branch: 89107, 11173467, 125.39381866744476
jump: 6217, 777227, 125.01640662699052
Mem-Reorder: 8871, 1098528, 123.83361515049036
```

`page-fault`, `branch`, `jump`, `Mem-Reorder` are corresponding to `Load/Store Page Fault`, `Branch Mispredict`, `Indirect Jump Mispredict`, `Memory Disambiguation`. The third number in each line is both TO and ETO in Table 3. 

## Execute one Testcase
If you want to execute the testcase in trigger_dataset, please execute the following command to replace the file path in dataset's swap_mem.cfg with correct absolute path.
```sh
python trigger_replace_path.py
```

Then you can execute the testcase in exp1-case directory. The command is instructed in `Execute one Testcase` in exp1-case's README. The STARSHIP_TESTCASE should be set as the abspath of the swap_mem.cfg of the target testcase.






